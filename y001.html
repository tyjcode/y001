<html>
<head>
    <title>Activators of POTA</title>
</head>
<body>

<p><span id="jaactivators"></span></p>
<p><span id="activators"></span></p>

<table id="table">
    <thead>
        <tr>
        <th data-field="activator"><button OnClick=sortOnClick(this)>activator</button></th>
        <th data-field="frequency"><button OnClick=sortOnClick(this)>frequency</button></th>
        <th data-field="mode"><button OnClick=sortOnClick(this)>mode</button></th>
        <th data-field="reference"><button OnClick=sortOnClick(this)>reference</button></th>
        <th data-field="parkname"><button OnClick=sortOnClick(this)>name</button></th>
        <th data-field="locationDesc"><button OnClick=sortOnClick(this)>locationDesc</button></th>
        </tr>
    </thead>
</table>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<script type="text/javascript">
    console.log("begin");

    var g_data = "";
    var g_name = "";
    loadparks();
    reloadfortable();

    const timer = 60000;
    window.addEventListener('load',function(){
        // setInterval('location.reload()',timer);
        setInterval('reloadfortable()',timer);
    });    

    console.log("End");

//
//
//
    function loadparks(){
        $.getJSON("https://tyjcode.github.io/y001/parks.json", function(name_json){

                g_parks = name_json;

            }); 
    }
    function replaceparks(){
        for (i = 0; i < g_data.length; i++) {
            var value = g_data[i]["reference"];

            var parks = g_parks.filter(function(item, index){ 
                            if (item.Reference == value ) return true; 
                        }); 

            var pref = "";
            for( var j = 0; j < parks.length; j++ ){ 
                pref =  pref + parks[j].都道府県 + ",";
                console.log( parks[j].Reference + ", " + parks[j].日本語名  + ", " + parks[j].都道府県 ); 
            } 

            if (parks.length > 0) {
                g_data[i]["name"] = parks[0].日本語名;
                g_data[i]["locationDesc"] = pref.slice(0,-1);
            }
        }
    }

    function reloadfortable(){
        $.getJSON("https://api.pota.app/spot/activator", function(data_json){

            var rows = "";
            var jaactivators = "";
            var activators = "";

            
            $("#jaactivators").text("");
            $("#activators").text("");
            for ( i=table.rows.length-1; i > 0; i--) {
                table.deleteRow(i); 
            }

    

            data_json.sort(function ( a, b ) {
                var r = 0;

                if( a.activator < b.activator ){ r = -1; }
                else { r = 1; }

                return r;
            });

            g_data = data_json;

            for (i = 0; i < data_json.length; i++) {
                if (data_json[i]["mode"] == "FT8" || data_json[i]["mode"] == "FT4") {
                    activators += data_json[i]["activator"];
                    activators +=  ","; 
                    if (data_json[i]["reference"].substr(0,2) == "JA"){
                        jaactivators += data_json[i]["activator"];
                        jaactivators +=  ",";                    
                    }
                }

                rows += "<tr>";
                for ( j=0; j < table.tHead.rows[0].cells.length; j++) {
                    rows = rows + "<td>" + data_json[i][table.tHead.rows[0].cells[j].textContent] + "</td>";
                }
                rows += "</tr>"; 

            }

            if (jaactivators == "") {
                $("#jaactivators").text("none");
            } else {
                $("#jaactivators").text(jaactivators.slice(0,-1));
            }
            if (activators == "") {
                $("#activators").text("none");
            } else {
                $("#activators").text(activators.slice(0,-1));
            }
            
            $("#table").append(rows); 

            replaceparks();
            rewrite(g_data);

        });
    }

    function sortOnClick(obj) {
        var key = obj.innerText;

        if (key == "frequency") {
            g_data.sort(function ( a, b ){
                var r = 0;
            
                if( parseFloat(a[key]) < parseFloat(b[key]) ){ r = -1; }
                else { r = 1; }
                return r;
            });    

        } else {
            g_data.sort(function ( a, b ){
                var r = 0;
            
                if( a[key] < b[key] ){ r = -1; }
                else { r = 1; }
                return r;
            });

        }
    
        rewrite(g_data)
    }

    function rewrite(data_json) {
        for (i = 0; i < data_json.length; i++) {
            for ( j=0; j < table.tHead.rows[0].cells.length; j++) {
                $("#table")[0].rows[i+1].cells[j].innerText = data_json[i][table.tHead.rows[0].cells[j].textContent] ;
            }
        }
    }

</script>

</html>
