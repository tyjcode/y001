<html>
<head></head>
<body>

<p><span id="jaactivators"></span></p>
<p><span id="activators"></span></p>

<table id="table">
    <thead>
        <tr>
        <th data-field="activator"><button OnClick=keyOnClick(this)>activator</button></th>
        <th data-field="frequency"><button OnClick=keyOnClick(this)>frequency</button></th>
        <th data-field="mode"><button OnClick=keyOnClick(this)>mode</button></th>
        <th data-field="reference"><button OnClick=keyOnClick(this)>reference</button></th>
        <th data-field="parkname"><button OnClick=keyOnClick(this)>name</button></th>
        <th data-field="locationDesc"><button OnClick=keyOnClick(this)>locationDesc</button></th>
        </tr>
    </thead>
</table>
</body>

<script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
<script type="text/javascript">
    console.log("begin");

    var g_data = "";
    reloadfortable();
    findpark();

    const timer = 60000;
 //   window.addEventListener('load',function(){
 //       setInterval('location.reload()',timer);
 //   });

    console.log("End");

//
//
//
    function reloadfortable(){
        $.getJSON("https://api.pota.app/spot/activator", function(data_json){

        var rows = "";
        var jaactivators = "";
        var activators = "";

        data_json.sort(function ( a, b ) {
            var r = 0;

            if( a.activator > b.activator ){ r = -1; }
            else { r = 1; }

            return r;
        });
        g_data = data_json;

        for (i = 0; i < data_json.length; i++) {
            if (data_json[i]["mode"] == "FT8" || data_json[i]["mode"] == "FT4") {
                activators += data_json[i]["activator"];
                activators +=  ","; 
                if (data_json[i]["reference"].substr(0,2) == "JA"){
                    jaactivators += data_json[i]["activator"];
                    jaactivators +=  ",";                    
                }
            }

            rows += "<tr>";
            for ( j=0; j < table.tHead.rows[0].cells.length; j++) {
                rows = rows + "<td>" + data_json[i][table.tHead.rows[0].cells[j].textContent] + "</td>";
            }
            rows += "</tr>"; 

        }

        if (jaactivators == "") {
            $("#jaactivators").text("none");
        } else {
            $("#jaactivators").text(jaactivators);
        }
        if (activators == "") {
            $("#activators").text("none");
        } else {
            $("#activators").text(activators);
        }
        
        $("#table").append(rows);   
        });
    }
    function findpark(){
        $.getJSON("https://tyjcode.github.io/y001/parks.json", function(name_json){
            for (i = 0; i < g_data.length; i++) {
                var value = g_data[i]["reference"];

                var parks = name_json.filter(function(item, index){ 
                                if (item.Reference == value ) return true; 
                            }); 

                var pref = "";
                for( var j = 0; j < parks.length; j++ ){ 
                    pref =  pref + parks[j].都道府県 + ", ";
                    console.log(parks[j].Reference + ", " + parks[j].日本語名  + ", " + parks[j].都道府県 ); 
                } 
                pref = pref.slice(0,-1);

                if (parks.length > 1) {
                    g_data[i]["reference"] = parks[0].日本語名;
                    g_data[i]["locationDesc"] = pref;
                }


                for ( j=0; j < table.tHead.rows[0].cells.length; j++) {
                    $("#table")[0].rows[i+1].cells[j].innerText = data_json[i][table.tHead.rows[0].cells[j].textContent] ;
            }
        }  
        rewrite(g_data);

        });
    }



    function keyOnClick(obj) {
        var key = obj.innerText;

        g_data.sort(function ( a, b ){
            var r = 0;
        
            if( a[key] < b[key] ){ r = -1; }
            else { r = 1; }
            return r;
        });

       
    
        rewrite(g_data)
    }

    function rewrite(data_json) {
        for (i = 0; i < data_json.length; i++) {
            for ( j=0; j < table.tHead.rows[0].cells.length; j++) {
                $("#table")[0].rows[i+1].cells[j].innerText = data_json[i][table.tHead.rows[0].cells[j].textContent] ;
            }
        }
    }

</script>

</html>
