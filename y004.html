<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>POTA Spot & Hunt Matcher</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Noto+Sans+JP:wght@400;500;700&display=swap');
        body {
            font-family: 'Inter', 'Noto Sans JP', sans-serif;
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* ソート可能なヘッダーのスタイル */
        .sortable-header {
            cursor: pointer;
            transition: background-color 0.15s;
        }
        .sortable-header:hover {
            background-color: #f3f4f6;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 min-h-screen">

    <!-- Header -->
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2">
                <i class="fa-solid fa-tree text-green-600 text-xl"></i>
                <h1 class="text-xl font-bold text-gray-900 tracking-tight">POTA Hunt Assistant</h1>
            </div>
            <div class="text-sm text-gray-500" id="clock">
                --:--
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">

        <!-- Status & Settings Panel -->
        <div class="bg-white rounded-lg shadow p-4 md:p-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Hunt Info Section -->
                <div class="space-y-3">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">
                        <i class="fa-solid fa-file-csv mr-1"></i> ハント情報 (CSV)
                    </h2>
                    <div id="csvStatus" class="text-sm p-3 bg-yellow-50 text-yellow-800 rounded border border-yellow-200">
                        データがありません。hunter_parks.csv を読み込んでください。
                    </div>
                    <div class="flex items-center gap-2">
                        <label class="cursor-pointer bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-sm font-medium transition shadow-sm">
                            <i class="fa-solid fa-upload mr-1"></i> CSVを読み込む
                            <input type="file" id="csvInput" accept=".csv" class="hidden">
                        </label>
                        <button onclick="clearCsvData()" class="text-red-600 hover:text-red-800 text-sm font-medium px-3 py-2">
                            クリア
                        </button>
                    </div>
                    <p class="text-xs text-gray-400">※初回のみ読込が必要です。データはブラウザに保存され、再起動後も維持されます。</p>
                </div>

                <!-- Spot Info Section -->
                <div class="space-y-3 border-t md:border-t-0 md:border-l border-gray-100 md:pl-6 pt-4 md:pt-0">
                    <h2 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">
                        <i class="fa-solid fa-satellite-dish mr-1"></i> スポット取得状況 (API)
                    </h2>
                    <div class="flex items-center justify-between">
                        <div class="text-sm">
                            <span id="spotCount" class="font-bold text-2xl text-gray-900">0</span>
                            <span class="text-gray-500">spots</span>
                        </div>
                        <div id="loadingIndicator" class="hidden">
                            <i class="fa-solid fa-circle-notch fa-spin text-blue-500"></i> 更新中...
                        </div>
                    </div>
                    <div class="text-xs text-gray-400">
                        最終更新: <span id="lastUpdated">--:--:--</span> (1分毎に自動更新)
                    </div>
                    <button onclick="fetchSpots()" class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
                        <i class="fa-solid fa-rotate-right"></i> 今すぐ更新
                    </button>
                </div>
            </div>
        </div>

        <!-- Data Table -->
        <div class="bg-white rounded-lg shadow overflow-hidden">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <!-- Time (UTC) - ソート可能 -->
                            <th id="sortTime" onclick="sortSpots('spotTime')" scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Time (UTC) <span id="sort-icon-spotTime" class="ml-1 opacity-40"></span>
                            </th>
                            <!-- Activator - ソート可能 -->
                            <th id="sortActivator" onclick="sortSpots('activator')" scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Activator <span id="sort-icon-activator" class="ml-1 opacity-40"></span>
                            </th>
                            <!-- Reference - ソート可能 -->
                            <th id="sortReference" onclick="sortSpots('reference')" scope="col" class="sortable-header px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Reference <span id="sort-icon-reference" class="ml-1 opacity-40"></span>
                            </th>
                            <!-- Info - ソート不可 -->
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Info</th>
                            <!-- My QSOs - ソート可能 (右寄せ) -->
                            <th id="sortMyQSOs" onclick="sortSpots('myQSOs')" scope="col" class="sortable-header px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">
                                My QSOs <span id="sort-icon-myQSOs" class="ml-1 opacity-40"></span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="spotTableBody" class="bg-white divide-y divide-gray-200">
                        <!-- Rows will be injected here -->
                        <tr>
                            <td colspan="5" class="px-6 py-12 text-center text-gray-500">
                                データを読み込んでいます...
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // --- 設定・状態 ---
        const POTA_API_URL = 'https://api.pota.app/spot/activator';
        const STORAGE_KEY = 'pota_hunter_parks_data';
        
        let state = {
            spots: [],
            hunts: {}, // Key: Reference, Value: QSOs count
            lastUpdate: null,
            sortKey: 'spotTime', // 初期ソートキー
            sortDirection: 'desc' // 初期ソート方向: 降順 (新しいものが上)
        };

        // --- 初期化処理 ---
        document.addEventListener('DOMContentLoaded', () => {
            loadHuntsFromStorage();
            fetchSpots();
            updateClock();

            // 1分ごとにスポット更新
            setInterval(fetchSpots, 60000);
            // 1秒ごとに時計更新
            setInterval(updateClock, 1000);

            // CSV入力イベントリスナー
            document.getElementById('csvInput').addEventListener('change', handleFileUpload);
        });

        function updateClock() {
            const now = new Date();
            document.getElementById('clock').textContent = now.toLocaleTimeString('ja-JP');
        }

        // --- 1. ハント情報の処理 (CSV & LocalStorage) ---

        // LocalStorageから読み込み
        function loadHuntsFromStorage() {
            const savedData = localStorage.getItem(STORAGE_KEY);
            if (savedData) {
                try {
                    state.hunts = JSON.parse(savedData);
                    updateCsvStatus(Object.keys(state.hunts).length);
                } catch (e) {
                    console.error("保存データの読み込みに失敗しました", e);
                    state.hunts = {};
                    updateCsvStatus(0);
                }
            } else {
                updateCsvStatus(0);
            }
        }

        // CSVアップロード処理
        function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const text = e.target.result;
                const parsedData = parseCSV(text);
                
                if (Object.keys(parsedData).length > 0) {
                    state.hunts = parsedData;
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(state.hunts));
                    updateCsvStatus(Object.keys(state.hunts).length);
                    // alert(`${Object.keys(state.hunts).length} 件のハント情報を読み込み、保存しました。`); // alertを避ける
                    console.log(`${Object.keys(state.hunts).length} 件のハント情報を読み込み、保存しました。`);
                    renderTable(); // 表示更新
                } else {
                    // alert('有効なデータが見つかりませんでした。CSVに「Reference」と「QSOs」列が含まれているか確認してください。'); // alertを避ける
                    console.error('有効なデータが見つかりませんでした。CSVに「Reference」と「QSOs」列が含まれているか確認してください。');
                }
            };
            reader.readAsText(file);
            // inputをリセット（同じファイルを再度選べるように）
            event.target.value = '';
        }

        // CSVパース処理
        function parseCSV(csvText) {
            const lines = csvText.split(/\r\n|\n/);
            const result = {};
            let headers = [];
            
            // ヘッダー行を探す
            if (lines.length > 0) {
                headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
            }

            const refIndex = headers.findIndex(h => h.toLowerCase() === 'reference');
            const qsoIndex = headers.findIndex(h => h.toLowerCase() === 'qsos');

            if (refIndex === -1) {
                console.error("CSV Header 'Reference' not found.");
                return {};
            }

            for (let i = 1; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // 簡易的なCSV分割 (引用符内のカンマは考慮しない簡易実装)
                const columns = line.split(',').map(c => c.trim().replace(/^"|"$/g, ''));
                
                if (columns.length > refIndex) {
                    const ref = columns[refIndex];
                    // QSOs列がない場合は0、あれば数値化
                    const qsos = (qsoIndex !== -1 && columns.length > qsoIndex) 
                                 ? parseInt(columns[qsoIndex]) || 0 
                                 : 0;
                    
                    if (ref) {
                        // 既存の値を上書き（最新のログファイルが優先される想定）
                        result[ref] = qsos;
                    }
                }
            }
            return result;
        }

        function updateCsvStatus(count) {
            const el = document.getElementById('csvStatus');
            if (count > 0) {
                el.className = "text-sm p-3 bg-green-50 text-green-800 rounded border border-green-200 flex items-center gap-2";
                el.innerHTML = `<i class="fa-solid fa-check-circle"></i> <span>保存済みデータ: <strong>${count}</strong> 件の公園情報を利用中</span>`;
            } else {
                el.className = "text-sm p-3 bg-yellow-50 text-yellow-800 rounded border border-yellow-200";
                el.innerHTML = "データがありません。hunter_parks.csv を読み込んでください。";
            }
        }

        function clearCsvData() {
            // NOTE: confirm()はCanvas環境では非推奨ですが、ここでは既存のコードを踏襲します
            if(confirm('保存されたハント情報を削除しますか？')) {
                localStorage.removeItem(STORAGE_KEY);
                state.hunts = {};
                updateCsvStatus(0);
                renderTable();
            }
        }

        // --- 2. スポット情報の取得 (API) ---

        async function fetchSpots() {
            const loadingEl = document.getElementById('loadingIndicator');
            loadingEl.classList.remove('hidden');

            try {
                const response = await fetch(POTA_API_URL);
                if (!response.ok) throw new Error('Network response was not ok');
                
                const data = await response.json();
                state.spots = data;
                
                // メタデータの更新
                document.getElementById('spotCount').textContent = data.length;
                const now = new Date();
                document.getElementById('lastUpdated').textContent = now.toLocaleTimeString('ja-JP');

                // APIからデータを取得した後、現在のソートキーでソートしてから表示
                sortSpots(state.sortKey, true); // trueでソート方向を維持してソート

            } catch (error) {
                console.error('Fetch error:', error);
                document.getElementById('spotTableBody').innerHTML = `
                    <tr><td colspan="5" class="px-6 py-4 text-center text-red-500">
                        データの取得に失敗しました。<br>しばらく待ってから再試行してください。
                    </td></tr>
                `;
            } finally {
                loadingEl.classList.add('hidden');
            }
        }

        // --- データのソート処理 ---
        function sortSpots(key, force = false) {
            // キーが変更された場合、ソート方向を初期化 (desc)
            if (state.sortKey !== key) {
                state.sortKey = key;
                state.sortDirection = 'desc';
            } 
            // キーが同じで、かつ強制ソートではない場合、ソート方向を反転
            else if (!force) {
                state.sortDirection = state.sortDirection === 'desc' ? 'asc' : 'desc';
            }

            const directionMultiplier = state.sortDirection === 'asc' ? 1 : -1;

            state.spots.sort((a, b) => {
                let valA, valB;

                switch (key) {
                    case 'myQSOs':
                        // myQSOsは計算値なので、ここで計算して比較
                        valA = state.hunts[a.reference] !== undefined ? state.hunts[a.reference] : 0;
                        valB = state.hunts[b.reference] !== undefined ? state.hunts[b.reference] : 0;
                        break;
                    case 'spotTime':
                        // 日付/時刻はそのまま比較 (新しいものが上=descが望ましい)
                        valA = a.spotTime;
                        valB = b.spotTime;
                        break;
                    case 'activator':
                    case 'reference':
                        // 文字列は小文字にして比較
                        valA = (a[key] || '').toLowerCase();
                        valB = (b[key] || '').toLowerCase();
                        break;
                    default:
                        // ソートキーが無効な場合は比較しない
                        return 0;
                }

                if (valA < valB) {
                    return -1 * directionMultiplier;
                }
                if (valA > valB) {
                    return 1 * directionMultiplier;
                }
                return 0;
            });

            renderTable();
        }

        // --- 3. データの結合と表示 ---

        function updateSortIcons() {
            // 全てのアイコンをリセット
            document.querySelectorAll('[id^="sort-icon-"]').forEach(icon => {
                icon.innerHTML = '';
                icon.classList.add('opacity-40');
            });

            // 現在のソートキーのアイコンを更新
            const iconEl = document.getElementById(`sort-icon-${state.sortKey}`);
            if (iconEl) {
                iconEl.innerHTML = state.sortDirection === 'asc' 
                    ? '<i class="fa-solid fa-arrow-up text-xs"></i>' 
                    : '<i class="fa-solid fa-arrow-down text-xs"></i>';
                iconEl.classList.remove('opacity-40');
                
                // ソート中のヘッダーの強調
                document.querySelectorAll('th[id^="sort"]').forEach(th => {
                    th.classList.remove('text-gray-900', 'font-semibold');
                    th.classList.add('text-gray-500', 'font-medium');
                });
                // ヘッダーIDは 'sort' + Keyの頭文字大文字 (例: sortTime)
                const thEl = document.getElementById(`sort${state.sortKey.charAt(0).toUpperCase() + state.sortKey.slice(1)}`);
                if (thEl) {
                    thEl.classList.add('text-gray-900', 'font-semibold');
                    thEl.classList.remove('text-gray-500', 'font-medium');
                }
            }
        }

        function renderTable() {
            const tbody = document.getElementById('spotTableBody');
            
            // ソートアイコンの更新
            updateSortIcons();

            if (state.spots.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="px-6 py-12 text-center text-gray-500">現在のスポットはありません</td></tr>`;
                return;
            }

            let html = '';

            // ソート済みのstate.spotsを利用して表示
            state.spots.forEach(spot => {
                // ハント情報との照合
                const myQSOs = state.hunts[spot.reference] !== undefined ? state.hunts[spot.reference] : 0;
                
                // 未交信（New One）かどうかでスタイル変更
                const isNewOne = myQSOs === 0;
                const rowClass = isNewOne ? "bg-green-50 hover:bg-green-100" : "hover:bg-gray-50 text-gray-600";
                const qsoBadgeClass = isNewOne 
                    ? "bg-green-100 text-green-800 border-green-200" 
                    : "bg-gray-100 text-gray-600 border-gray-200";

                // スポット時間の整形
                const timeStr = spot.spotTime ? spot.spotTime.substring(11, 16) : "--:--";

                html += `
                    <tr class="transition-colors duration-150 border-b border-gray-100 animate-fade-in ${rowClass}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-mono text-gray-500">
                            ${timeStr} <span class="text-xs text-gray-400">UTC</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-bold text-gray-900">${spot.activator}</div>
                            <div class="text-xs text-gray-500">${spot.mode || ''} / ${spot.frequency || ''}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">
                                ${spot.reference}
                            </span>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-sm text-gray-900 line-clamp-1" title="${spot.name}">${spot.name}</div>
                            <div class="text-xs text-gray-500 truncate" title="${spot.locationDesc}">${spot.locationDesc}</div>
                            ${spot.comments ? `<div class="text-xs text-gray-400 mt-1 italic line-clamp-1">"${spot.comments}"</div>` : ''}
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-right">
                            <div class="flex flex-col items-end">
                                <span class="px-3 py-1 inline-flex text-sm font-bold rounded-md border ${qsoBadgeClass}">
                                    ${myQSOs} QSOs
                                </span>
                                ${isNewOne ? '<span class="text-xs text-green-600 font-bold mt-1">NEW!</span>' : ''}
                            </div>
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }
    </script>
</body>
</html>